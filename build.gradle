plugins {
    id 'java'
    id 'application'
}

group = 'org.mangorage'
version = "$TSML_VERSION"

repositories {
    mavenCentral()
}

configurations {
    jarJarLoader {
        canBeResolved = true
        canBeConsumed = false
    }
    jarJarMod {
        canBeResolved = true
        canBeConsumed = false
    }
}


dependencies {
    jarJarLoader(project(":Loader"))


    jarJarMod(project(":BuiltInMods:TSMLMixin"))
    jarJarMod(project(":BuiltInMods:TSMLCore"))
}

application {
    // CHANGE THIS or it WILL explode
    mainClass = 'org.mangorage.tsml.bootstrap.Bootstrap'
}

jar {
    manifest {
        attributes(
                'Main-Class': application.mainClass
        )
    }
}

task fatJar(type: Jar) {
    archiveBaseName.set('TSML')
    archiveClassifier.set('') // Creates MixinMod-all.jar

    // Your compiled classes
    from sourceSets.main.output

    // Include the compileOnly jars themselves (as .jar files) inside JarJar/
    from {
        configurations.jarJarLoader
    } {
        into 'JarJarLoader'
    }

    from {
        configurations.jarJarMod
    } {
        into 'JarJarMods'
    }

    // Add output.txt listing the jars inside JarJar/
    from {
        // Build a temporary file with the jar names
        def tmpFile = new File(temporaryDir, "output.txt")
        tmpFile.text = configurations.jarJarLoader.files.collect { it.name }.join(System.lineSeparator())
        tmpFile
    } {
        into 'JarJarLoader' // Put the file inside the JarJar folder
    }

    // Add output.txt listing the jars inside JarJar/
    from {
        // Build a temporary file with the jar names
        def tmpFile = new File(temporaryDir, "output.txt")
        tmpFile.text = configurations.jarJarMod.files.collect { it.name }.join(System.lineSeparator())
        tmpFile
    } {
        into 'JarJarMods' // Put the file inside the JarJar folder
    }

    manifest {
        attributes(
                'Main-Class': application.mainClass
        )
    }


    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

tasks.register('runGame', JavaExec) {
    group = 'application'
    description = 'Runs the TriviaSpire game because clicking buttons is hard'

    classpath = fatJar.outputs.files
    mainClass = application.mainClass

    // THIS is the part your brain skipped
    workingDir = file("$buildDir/run")

    doFirst {
        workingDir.mkdirs()
    }

    // Use Java 17 JRE
    javaLauncher = javaToolchains.launcherFor {
        languageVersion = JavaLanguageVersion.of(17)
    }


    // optional JVM args, because games like memory
    jvmArgs '-Xms512M', '-Xmx2G'
}